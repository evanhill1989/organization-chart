import{a as d,p as s}from"./chunk-PVWAREVJ-C9qE2fA-.js";import{S as ae,s as ie,h as V,g as oe,n as z,u as k,b as ce,c as le}from"./QueryClientProvider-CkIEaHTJ.js";import{s as w}from"./supabaseClient-BIEPa1cA.js";var ue=class extends ae{#t;#n=void 0;#e;#r;constructor(e,r){super(),this.#t=e,this.setOptions(r),this.bindMethods(),this.#s()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){const r=this.options;this.options=this.#t.defaultMutationOptions(e),ie(this.options,r)||this.#t.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#e,observer:this}),r?.mutationKey&&this.options.mutationKey&&V(r.mutationKey)!==V(this.options.mutationKey)?this.reset():this.#e?.state.status==="pending"&&this.#e.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#e?.removeObserver(this)}onMutationUpdate(e){this.#s(),this.#a(e)}getCurrentResult(){return this.#n}reset(){this.#e?.removeObserver(this),this.#e=void 0,this.#s(),this.#a()}mutate(e,r){return this.#r=r,this.#e?.removeObserver(this),this.#e=this.#t.getMutationCache().build(this.#t,this.options),this.#e.addObserver(this),this.#e.execute(e)}#s(){const e=this.#e?.state??oe();this.#n={...e,isPending:e.status==="pending",isSuccess:e.status==="success",isError:e.status==="error",isIdle:e.status==="idle",mutate:this.mutate,reset:this.reset}}#a(e){z.batch(()=>{if(this.#r&&this.hasListeners()){const r=this.#n.variables,n=this.#n.context;e?.type==="success"?(this.#r.onSuccess?.(e.data,r,n),this.#r.onSettled?.(e.data,null,r,n)):e?.type==="error"&&(this.#r.onError?.(e.error,r,n),this.#r.onSettled?.(void 0,e.error,r,n))}this.listeners.forEach(r=>{r(this.#n)})})}};function R(e,r){const n=k(),[t]=d.useState(()=>new ue(n,e));d.useEffect(()=>{t.setOptions(e)},[t,e]);const a=d.useSyncExternalStore(d.useCallback(l=>t.subscribe(z.batchCalls(l)),[t]),()=>t.getCurrentResult(),()=>t.getCurrentResult()),c=d.useCallback((l,i)=>{t.mutate(l,i).catch(ce)},[t]);if(a.error&&le(t.options.throwOnError,[a.error]))throw a.error;return{...a,mutate:c,mutateAsync:a.mutate}}const p={orgTree:e=>["orgTree",e],allOrgTrees:()=>["orgTree"],task:e=>["task",e],allTasks:()=>["allTasks"],recentTasks:()=>["recentTasks"],urgentTaskCount:e=>e?["urgentTaskCount",e]:["urgentTaskCount"],criticalTaskCount:e=>["criticalTaskCount",e],category:e=>["category",e],allCategories:()=>["categories"],journalEntry:e=>["journalEntry",e]},de=()=>{const e=k();return R({mutationFn:async r=>{const{data:{user:n}}=await w.auth.getUser();if(!n)throw new Error("User not authenticated");if(r.id){const{data:t,error:a}=await w.from("org_nodes").update(r).eq("id",r.id).eq("user_id",n.id).select().single();if(a)throw a;return t}else{const{data:t,error:a}=await w.from("org_nodes").insert({...r,type:"task",user_id:n.id}).select().single();if(a)throw a;return t}},onSuccess:r=>{e.setQueryData(p.task(r.id),r),e.invalidateQueries({queryKey:p.allOrgTrees()}),e.invalidateQueries({queryKey:p.allTasks()}),e.invalidateQueries({queryKey:p.urgentTaskCount()})},onError:r=>{console.error("‚ùå Save task error:",r)}})},he=()=>{const e=k();return R({mutationFn:async r=>{const{data:{user:n}}=await w.auth.getUser();if(!n)throw new Error("User not authenticated");const{error:t}=await w.from("org_nodes").delete().eq("id",r).eq("user_id",n.id);if(t)throw t;return r},onSuccess:r=>{e.removeQueries({queryKey:p.task(r)}),e.invalidateQueries({queryKey:p.allOrgTrees()}),e.invalidateQueries({queryKey:p.allTasks()}),e.invalidateQueries({queryKey:p.urgentTaskCount()})},onError:r=>{console.error("‚ùå Delete task error:",r)}})};function me(e,r){const n=new Date(e),t=new Date(n);switch(r.type){case"minutely":return t.setMinutes(t.getMinutes()+r.interval),t.toISOString();case"daily":t.setDate(t.getDate()+r.interval);break;case"weekly":if(r.dayOfWeek!==void 0){const a=(r.dayOfWeek-t.getDay()+7)%7;t.setDate(t.getDate()+a+(r.interval-1)*7)}else t.setDate(t.getDate()+r.interval*7);break;case"monthly":if(r.dayOfMonth!==void 0)t.setMonth(t.getMonth()+r.interval),t.setDate(Math.min(r.dayOfMonth,Y(t)));else{const a=n.getDate();t.setMonth(t.getMonth()+r.interval),t.setDate(Math.min(a,Y(t)))}break;case"yearly":t.setFullYear(t.getFullYear()+r.interval);break;default:throw new Error(`Unsupported recurrence type: ${r.type}`)}return r.type==="minutely"?t.toISOString():t.toISOString().split("T")[0]}function ge(e,r){if(!r)return!0;const n=new Date(e),t=new Date(r);return n<=t}function Y(e){return new Date(e.getFullYear(),e.getMonth()+1,0).getDate()}function ye(e){const{type:r,interval:n,dayOfWeek:t,dayOfMonth:a}=e,c=n===1?"Weekly":`Every ${n} weeks`,l=n===1?"Monthly":`Every ${n} months`,i=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];switch(r){case"minutely":return n===1?"Every minute":`Every ${n} minutes`;case"daily":return n===1?"Daily":`Every ${n} days`;case"weekly":return t!==void 0?`${c} on ${i[t]}`:c;case"monthly":if(a!==void 0){const u=fe(a);return`${l} on the ${a}${u}`}return l;case"yearly":return n===1?"Yearly":`Every ${n} years`;default:return"No recurrence"}}function fe(e){if(e>=11&&e<=13)return"th";switch(e%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}function pe({initialConfig:e,onChange:r,disabled:n=!1,className:t=""}){const[a,c]=d.useState(e?.type||"none"),[l,i]=d.useState(e?.interval||1),[u,_]=d.useState(e?.dayOfWeek??""),[y,h]=d.useState(e?.dayOfMonth??""),[f,N]=d.useState(e?.endDate||""),E=d.useRef("");return d.useEffect(()=>{if(e){const m=JSON.stringify(e);m!==E.current&&(console.log("üîÑ RecurrenceConfig: Updating from initialConfig:",e),c(e.type||"none"),i(e.interval||1),_(e.dayOfWeek??""),h(e.dayOfMonth??""),N(e.endDate||""),E.current=m)}},[e]),d.useEffect(()=>{const m={recurrence_type:a,recurrence_interval:a!=="none"?l:void 0,recurrence_day_of_week:a==="weekly"&&u!==""?Number(u):void 0,recurrence_day_of_month:a==="monthly"&&y!==""?Number(y):void 0,recurrence_end_date:a!=="none"&&f?f:void 0,is_recurring_template:a!=="none"};console.log("üîÑ RecurrenceConfig: Emitting config change:",m),r(m)},[a,l,u,y,f]),s.jsxs("div",{className:`rounded border bg-gray-50 p-4 dark:bg-gray-800 ${t}`,children:[s.jsxs("h4",{className:"mb-3 flex items-center font-medium text-gray-700 dark:text-gray-300",children:[s.jsx("svg",{className:"mr-2 h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:s.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})}),"Repeat Task"]}),s.jsxs("div",{className:"mb-3",children:[s.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Repeat:"}),s.jsxs("select",{className:"w-full rounded border border-gray-300 px-3 py-2 text-black focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white",value:a,onChange:m=>{console.log("üîÑ RecurrenceConfig: Type changed to:",m.target.value),c(m.target.value)},disabled:n,children:[s.jsx("option",{value:"none",children:"No repeat"}),s.jsx("option",{value:"minutely",children:"Every minute (testing)"}),s.jsx("option",{value:"daily",children:"Daily"}),s.jsx("option",{value:"weekly",children:"Weekly"}),s.jsx("option",{value:"monthly",children:"Monthly"}),s.jsx("option",{value:"yearly",children:"Yearly"})]})]}),a!=="none"&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"mb-3",children:[s.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Every:"}),s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx("input",{type:"number",min:"1",max:"365",className:"w-20 rounded border border-gray-300 px-3 py-2 text-black focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white",value:l,onChange:m=>i(Number(m.target.value)),disabled:n}),s.jsxs("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:[a==="minutely"&&(l===1?"minute":"minutes"),a==="daily"&&(l===1?"day":"days"),a==="weekly"&&(l===1?"week":"weeks"),a==="monthly"&&(l===1?"month":"months"),a==="yearly"&&(l===1?"year":"years")]})]})]}),a==="weekly"&&s.jsxs("div",{className:"mb-3",children:[s.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"On day:"}),s.jsxs("select",{className:"w-full rounded border border-gray-300 px-3 py-2 text-black focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white",value:u,onChange:m=>_(m.target.value?Number(m.target.value):""),disabled:n,children:[s.jsx("option",{value:"",children:"Same day as deadline"}),s.jsx("option",{value:"0",children:"Sunday"}),s.jsx("option",{value:"1",children:"Monday"}),s.jsx("option",{value:"2",children:"Tuesday"}),s.jsx("option",{value:"3",children:"Wednesday"}),s.jsx("option",{value:"4",children:"Thursday"}),s.jsx("option",{value:"5",children:"Friday"}),s.jsx("option",{value:"6",children:"Saturday"})]})]}),a==="monthly"&&s.jsxs("div",{className:"mb-3",children:[s.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"On day of month:"}),s.jsxs("select",{className:"w-full rounded border border-gray-300 px-3 py-2 text-black focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white",value:y,onChange:m=>h(m.target.value?Number(m.target.value):""),disabled:n,children:[s.jsx("option",{value:"",children:"Same day as deadline"}),Array.from({length:31},(m,O)=>O+1).map(m=>s.jsx("option",{value:m,children:m},m))]})]}),s.jsxs("div",{className:"mb-3",children:[s.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"End repeat (optional):"}),s.jsx("input",{type:"date",className:"w-full rounded border border-gray-300 px-3 py-2 text-black focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white",value:f,onChange:m=>N(m.target.value),min:new Date().toISOString().split("T")[0],disabled:n})]}),s.jsxs("div",{className:"mt-3 rounded border-l-4 border-blue-400 bg-blue-50 p-2 dark:bg-blue-900/20",children:[s.jsxs("p",{className:"text-sm text-blue-700 dark:text-blue-300",children:[s.jsx("strong",{children:"Pattern:"})," ",ye({type:a,interval:l,dayOfWeek:u!==""?Number(u):void 0,dayOfMonth:y!==""?Number(y):void 0})]}),f&&s.jsxs("p",{className:"mt-1 text-sm text-blue-700 dark:text-blue-300",children:[s.jsx("strong",{children:"Ends:"})," ",new Date(f).toLocaleDateString()]})]})]})]})}async function _e(e){if(console.log("üîç DEBUG - createRecurringInstance called with task:",{name:e.name,id:e.id,is_completed:e.is_completed,is_recurring_template:e.is_recurring_template,recurring_template_id:e.recurring_template_id,recurrence_type:e.recurrence_type,deadline:e.deadline,parent_id:e.parent_id}),console.log("üîÑ createRecurringInstance called for task:",e.name),!e.is_recurring_template&&!e.recurring_template_id)return console.log("‚ùå Check 1 FAILED: Task is not recurring",{is_recurring_template:e.is_recurring_template,recurring_template_id:e.recurring_template_id}),null;if(console.log("‚úÖ Check 1 PASSED: Task is recurring"),e.recurrence_type==="none"||!e.recurrence_type)return console.log("‚ùå Check 2 FAILED: No recurrence type set",{recurrence_type:e.recurrence_type}),null;if(console.log("‚úÖ Check 2 PASSED: Recurrence type is set:",e.recurrence_type),!e.is_completed)return console.log("‚ùå Check 3 FAILED: Task is not marked as completed",{is_completed:e.is_completed}),null;console.log("‚úÖ Check 3 PASSED: Task is completed"),console.log("üîç Check 4: Checking for recent instances...");const r=new Date(Date.now()-6e4).toISOString();let n=w.from("org_nodes").select("id, name, created_at").eq("name",e.name).eq("user_id",e.user_id).eq("recurring_template_id",e.is_recurring_template?e.id:e.recurring_template_id).gte("created_at",r);e.parent_id!=null?n=n.eq("parent_id",e.parent_id):n=n.is("parent_id",null);const{data:t,error:a}=await n;if(a)throw console.error("‚ùå Check 4 ERROR: Error checking for recent instances:",a),a;if(console.log("üîç Check 4 RESULT: Recent instances found:",t),t&&t.length>0)return console.log("‚ùå Check 4 FAILED: Recent instance already exists, skipping creation"),null;console.log("‚úÖ Check 4 PASSED: No recent instances found"),console.log("üîç Check 5: Calculating next deadline...");try{const c=me(e.deadline||new Date().toISOString().split("T")[0],{type:e.recurrence_type,interval:e.recurrence_interval||1,dayOfWeek:e.recurrence_day_of_week,dayOfMonth:e.recurrence_day_of_month,endDate:e.recurrence_end_date});if(console.log("‚úÖ Check 5 PASSED: Next deadline calculated:",c),!ge(c,e.recurrence_end_date))return console.log("‚ùå Check 6 FAILED: Recurrence end date reached",{nextDeadline:c,endDate:e.recurrence_end_date}),null;console.log("‚úÖ Check 6 PASSED: Should create next instance"),console.log(e,"THE FUCKING COMPLETED TASK!!!"),console.log(e.parent_id,"THE FUCKING COMPLETED TASK PARENT_ID!!!!!!!!");const l={name:e.name,type:"task",details:e.details,importance:e.importance,deadline:c,completion_time:e.completion_time,unique_days_required:e.unique_days_required,parent_id:e.parent_id||null,tab_name:e.tab_name,root_category:e.root_category,recurrence_type:e.recurrence_type,recurrence_interval:e.recurrence_interval,recurrence_day_of_week:e.recurrence_day_of_week,recurrence_day_of_month:e.recurrence_day_of_month,recurrence_end_date:e.recurrence_end_date,is_recurring_template:!1,recurring_template_id:e.is_recurring_template?e.id:e.recurring_template_id,user_id:e.user_id};console.log("üîç DEBUG - newTaskData before insertion:",l),console.log("üîÑ Creating next recurring instance:",{originalTask:e.name,newDeadline:c,recurrenceType:e.recurrence_type,newTaskData:l});const{data:i,error:u}=await w.from("org_nodes").insert([l]).select().single();if(u)throw console.error("‚ùå Database error creating recurring instance:",u),u;return console.log("‚úÖ Successfully created recurring instance:",i),i}catch(c){throw console.error("‚ùå Failed to create recurring instance:",c),c}}function be(){const e=k();return R({mutationFn:async r=>{const{data:{user:n}}=await w.auth.getUser();if(!n)throw new Error("User not authenticated");const{error:t}=await w.from("org_nodes").update({last_touched_at:new Date().toISOString()}).eq("id",r).eq("user_id",n.id);if(t)throw t},onSuccess:()=>{e.invalidateQueries({queryKey:p.recentTasks()})}})}async function xe({id:e,name:r,details:n,importance:t,deadline:a,completion_time:c,unique_days_required:l,is_completed:i,completed_at:u,completion_comment:_}){const{data:{user:y}}=await w.auth.getUser();if(!y)throw new Error("User not authenticated");const h={};r!==void 0&&(h.name=r),n!==void 0&&(h.details=n),t!==void 0&&(h.importance=t),a!==void 0&&(h.deadline=a),c!==void 0&&(h.completion_time=c),l!==void 0&&(h.unique_days_required=l),i!==void 0&&(h.is_completed=i),u!==void 0&&(h.completed_at=u??void 0),_!==void 0&&(h.completion_comment=_),h.last_touched_at=new Date().toISOString();const{data:f,error:N}=await w.from("org_nodes").update(h).eq("id",e).eq("user_id",y.id).select().single();if(N)throw N;return f}const ve={traverse(e,r){r(e),e.children&&e.children.length>0&&e.children.forEach(n=>this.traverse(n,r))},findById(e,r){if(e.id===r)return e;if(e.children&&e.children.length>0)for(const n of e.children){const t=this.findById(n,r);if(t)return t}return null},updateNode(e,r,n){if(e.id===r)return{...e,...n};if(e.children&&e.children.length>0){const t=e.children.map(a=>this.updateNode(a,r,n));return{...e,children:t}}return e},addChild(e,r,n){return r?e.id===r?{...e,children:[...e.children??[],n]}:e.children&&e.children.length>0?{...e,children:e.children.map(t=>this.addChild(t,r,n))}:e:{...e,children:[...e.children??[],n]}},removeNode(e,r){if(e.id===r)return null;if(e.children&&e.children.length>0){const n=e.children.map(t=>this.removeNode(t,r)).filter(t=>t!==null);return{...e,children:n}}return e},getDescendants(e){const r=[e];return e.children&&e.children.length>0&&e.children.forEach(n=>{r.push(...this.getDescendants(n))}),r},getNodePath(e,r){if(e.id===r)return[e];if(e.children&&e.children.length>0)for(const n of e.children){const t=this.getNodePath(n,r);if(t.length>0)return[e,...t]}return[]},countNodes(e){let r=1;return e.children&&e.children.length>0&&(r+=e.children.reduce((n,t)=>n+this.countNodes(t),0)),r},getMaxDepth(e){return!e.children||e.children.length===0?1:1+Math.max(...e.children.map(r=>this.getMaxDepth(r)))},filter(e,r){const n=[];return this.traverse(e,t=>{r(t)&&n.push(t)}),n},map(e,r){const n=r(e);return n.children&&n.children.length>0?{...n,children:n.children.map(t=>this.map(t,r))}:n}};function we(e){const r=k();return R({mutationFn:async t=>await xe(t),onMutate:async t=>{await r.cancelQueries({queryKey:p.orgTree(e)});const a=r.getQueryData(p.orgTree(e));if(!a||!t.id)return{previousTree:null};const c={};t.name!==void 0&&(c.name=t.name),t.details!==void 0&&(c.details=t.details),t.importance!==void 0&&(c.importance=t.importance),t.deadline!==void 0&&(c.deadline=t.deadline),t.completion_time!==void 0&&(c.completion_time=t.completion_time),t.unique_days_required!==void 0&&(c.unique_days_required=t.unique_days_required),t.is_completed!==void 0&&(c.is_completed=t.is_completed),t.completed_at!==void 0&&(c.completed_at=t.completed_at===null?void 0:t.completed_at),t.completion_comment!==void 0&&(c.completion_comment=t.completion_comment);const l=ve.updateNode(a,t.id,c);return r.setQueryData(p.orgTree(e),l),{previousTree:a}},onError:(t,a,c)=>{console.log("‚ùå EDIT ONERROR: Edit failed for node:",a.id,"Error:",t),c?.previousTree&&r.setQueryData(p.orgTree(e),c.previousTree)},onSettled:()=>{r.invalidateQueries({queryKey:p.orgTree(e)}),r.invalidateQueries({queryKey:p.urgentTaskCount()}),r.invalidateQueries({queryKey:p.recentTasks()})}})}function J(e,r,n){if(!e||!r||!n)return 1;const t=new Date,c=new Date(e).getTime()-t.getTime(),l=Math.ceil(c/(1e3*3600*24));if(l<=0||n>=l)return 10;try{const i=n/l*(r/l)+Math.exp(4*(n/l)/(1-n/l))-1;return i<.25?1:i>=.25&&i<.5?2:i>=.5&&i<1?3:i>=1&&i<1.75?4:i>=1.75&&i<2.5?5:i>=2.5&&i<4?6:i>=4&&i<5.5?7:i>=5.5&&i<7.5?8:i>=7.5&&i<10?9:10}catch(i){return console.warn("Urgency calculation failed:",i),1}}function Ne(e){return e.type!=="task"?1:J(e.deadline,e.completion_time,e.unique_days_required)}function ke(e=1){switch(e){case 1:return"";case 2:return"bg-lime-400";case 3:return"bg-yellow-400";case 4:return"bg-yellow-500";case 5:return"bg-amber-500";case 6:return"bg-orange-400";case 7:return"bg-orange-500";case 8:return"bg-red-400";case 9:return"bg-red-500";case 10:return"bg-red-600";default:return""}}function Oe(e=1){if(e<=1)return"";switch(e){case 2:case 3:return"w-2 h-2";case 4:case 5:case 6:return"w-3 h-3";case 7:case 8:return"w-4 h-4";case 9:case 10:return"w-5 h-5";default:return"w-2 h-2"}}function je(e=1){if(e<=1)return 0;switch(e){case 2:return 4;case 3:return 3.5;case 4:return 3;case 5:return 2.5;case 6:return 2;case 7:return 1.5;case 8:return 1.2;case 9:return 1;case 10:return .8;default:return 2}}function Me(e=1){if(e<=1)return"";switch(e){case 2:return"shadow-sm shadow-lime-400/50";case 3:return"shadow-sm shadow-yellow-400/50";case 4:return"shadow-sm shadow-yellow-500/50";case 5:return"shadow-md shadow-amber-500/50";case 6:return"shadow-md shadow-orange-400/50";case 7:return"shadow-md shadow-orange-500/50";case 8:return"shadow-lg shadow-red-400/60";case 9:return"shadow-lg shadow-red-500/70";case 10:return"shadow-xl shadow-red-600/80";default:return""}}function $e(e=1){return e>1}function qe(e){const r=e.getBoundingClientRect(),n=r.width,t=r.height,a=window.getComputedStyle(e),c=parseFloat(a.borderRadius)||8,l=Math.min(n,t)/2,i=Math.min(c,l),u=[],_=0,y=n,h=0,f=t;return u.push(`M ${n/2} ${h}`),u.push(`L ${y-i} ${h}`),u.push(`Q ${y} ${h} ${y} ${h+i}`),u.push(`L ${y} ${f-i}`),u.push(`Q ${y} ${f} ${y-i} ${f}`),u.push(`L ${_+i} ${f}`),u.push(`Q ${_} ${f} ${_} ${f-i}`),u.push(`L ${_} ${h+i}`),u.push(`Q ${_} ${h} ${_+i} ${h}`),u.push(`L ${n/2} ${h}`),u.join(" ")}function Re(e=1){return{duration:je(e),ease:"none",repeat:-1,autoRotate:e>=7,yoyo:!1}}function X(e){if(e.type==="task")return Ne(e);if(!e.children||e.children.length===0)return 1;const r=e.children.map(n=>X(n));return Math.max(...r)}function Te(e){return X(e)}function Se(e){const r="https://calendar.google.com/calendar/render",n=new URLSearchParams({action:"TEMPLATE"});n.append("text",e.name);const t=[];if(e.importance&&t.push(`‚≠ê Importance: ${e.importance}/10`),e.deadline&&e.completion_time!==void 0&&e.unique_days_required!==void 0){const a=J(e.deadline,e.completion_time,e.unique_days_required);t.push(`üî• Urgency: ${a}/10`)}return e.details&&t.push("","üìã DETAILS:",e.details),e.completion_time&&t.push("",`‚è±Ô∏è Estimated time: ${e.completion_time} minutes`),n.append("details",t.join(`
`)),`${r}?${n.toString()}`}function Ue({task:e,onCancel:r,parentId:n,parentName:t,rootCategory:a,tabName:c}){const[l,i]=d.useState(e?.name??""),[u,_]=d.useState(e?.details??""),[y,h]=d.useState(e?.importance??1),[f,N]=d.useState(e?.deadline??""),[E,m]=d.useState(e?.completion_time??1),[O,Q]=d.useState(e?.unique_days_required??1),[g,K]=d.useState(e?.is_completed??!1),[M,W]=d.useState(e?.completion_comment??""),[j,T]=d.useState(e?.completed_at??null),[b,B]=d.useState({recurrence_type:"none",recurrence_interval:void 0,recurrence_day_of_week:void 0,recurrence_day_of_month:void 0,recurrence_end_date:void 0,is_recurring_template:!1}),U=de(),I=he(),Z=be(),A=we(e?.root_category||""),C=!e,S=!!e,$=d.useRef(!1),L=d.useRef(!1),[x,P]=d.useState(!1);d.useEffect(()=>{if(e){i(e.name),_(e.details??""),h(e.importance??1),N(e.deadline??""),m(e.completion_time??1),Q(e.unique_days_required??1),K(e.is_completed??!1),W(e.completion_comment??""),T(e.completed_at??null);const o=e.recurrence_type||"none";B({recurrence_type:o,recurrence_interval:o!=="none"?e.recurrence_interval||1:void 0,recurrence_day_of_week:o==="weekly"?e.recurrence_day_of_week:void 0,recurrence_day_of_month:o==="monthly"?e.recurrence_day_of_month:void 0,recurrence_end_date:o!=="none"?e.recurrence_end_date:void 0,is_recurring_template:o!=="none"}),$.current=!1,P(!1)}},[e]),d.useEffect(()=>{e?.id&&Z.mutate(String(e.id))},[e?.id]);const ee=o=>{K(o),P(!0),o&&!e?.is_completed?T(new Date().toISOString()):!o&&e?.is_completed&&T(null)},re=async()=>{if(!e)return;if(L.current){console.log("üîÑ Already processing completion, skipping...");return}L.current=!0;const o={id:e.id,is_completed:g,completion_comment:M||void 0,completed_at:j||void 0};console.log("üöÄ Saving task completion:",o),A.mutate(o,{onSuccess:async()=>{if(console.log("‚úÖ Task completion saved successfully"),P(!1),g&&!e.is_completed&&!$.current&&b.recurrence_type!=="none"&&b.recurrence_type){console.log("üîÑ Task completed with recurrence, creating next instance..."),$.current=!0;try{const v={...e,is_completed:!0,completed_at:j||void 0,completion_comment:M,recurrence_type:b.recurrence_type,recurrence_interval:b.recurrence_interval,recurrence_day_of_week:b.recurrence_day_of_week,recurrence_day_of_month:b.recurrence_day_of_month,recurrence_end_date:b.recurrence_end_date,is_recurring_template:b.is_recurring_template},D=await _e(v);D&&console.log("‚úÖ Successfully created recurring instance:",D.name)}catch(v){console.error("‚ùå Failed to create recurring instance:",v),$.current=!1}}g&&r()},onError:v=>{console.error("‚ùå Failed to save task completion:",v),alert(`Failed to save completion: ${v.message}`)},onSettled:()=>{L.current=!1}})},te=o=>{o.preventDefault();const v=e?.parent_id??n,D=e?.root_category??a,F=e?.tab_name??c;if(C&&(!v||!D||!F)){console.error("‚ùå Missing required parent context for new task:",{parentId:v,rootCategory:D,tabName:F}),alert("Missing parent information. Please try again.");return}const G={id:e?.id,name:l.trim(),details:u.trim()||void 0,importance:y,deadline:f||void 0,completion_time:E,unique_days_required:O,parent_id:v,root_category:D,tab_name:F,type:"task",...S&&!x&&{is_completed:g,completion_comment:M||void 0,completed_at:j||void 0},...b};console.log("üöÄ Submitting task data:",G),U.mutate(G,{onSuccess:q=>{console.log("‚úÖ Task saved successfully:",q),r()},onError:q=>{console.error("‚ùå Failed to save task:",q),alert(`Failed to save task: ${q.message}`)}})},ne=()=>{if(e?.id){if(!confirm(`Are you sure you want to delete "${e.name}"?`))return;console.log("üóëÔ∏è Deleting task:",e.id),I.mutate(e.id,{onSuccess:()=>{console.log("‚úÖ Task deleted successfully"),r()},onError:o=>{console.error("‚ùå Failed to delete task:",o),alert(`Failed to delete task: ${o.message}`)}})}},se=o=>o?new Date(o).toISOString().split("T")[0]:"",H=()=>S&&e?.root_category?e.root_category:C&&t&&a?`${a} > ${t}`:"Unknown";return s.jsx("div",{className:"bg-opacity-50 fixed inset-0 z-[70] flex items-center justify-center bg-black",children:s.jsxs("form",{onSubmit:te,className:"mx-4 max-h-[90vh] w-full max-w-md space-y-4 overflow-y-auto rounded-lg bg-white p-6 text-black shadow-md",children:[s.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("h3",{className:"text-xl font-bold",children:C?"Create New Task":"Edit Task"}),s.jsx("p",{className:"text-sm text-gray-600",children:C?`Adding to: ${H()}`:`Category: ${H()}`})]}),s.jsx("button",{type:"button",onClick:r,className:"text-2xl font-bold text-gray-500 hover:text-gray-800",children:"√ó"})]}),S&&s.jsxs("div",{className:`mb-6 rounded-lg border p-4 ${g?"border-green-300 bg-green-50":"border-gray-200 bg-gray-50"}`,children:[s.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[s.jsxs("label",{className:"flex cursor-pointer items-center font-semibold text-gray-700",children:[s.jsx("input",{type:"checkbox",checked:g,onChange:o=>ee(o.target.checked),className:"mr-2 h-5 w-5 cursor-pointer rounded text-green-600 focus:ring-green-500"}),s.jsx("span",{className:g?"text-green-700":"",children:g?"Task Completed":"Mark as Completed"})]}),j&&s.jsx("span",{className:"text-sm text-gray-500",children:new Date(j).toLocaleDateString()})]}),g&&s.jsxs("div",{className:"mt-3",children:[s.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Completion Notes (optional):"}),s.jsx("textarea",{className:"w-full rounded border p-2 text-sm text-black focus:border-green-500 focus:ring-2 focus:ring-green-500",rows:3,placeholder:"Add any notes about completing this task...",value:M,onChange:o=>W(o.target.value)}),j&&s.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["Completed on ",new Date(j).toLocaleString()]})]}),S&&x&&g&&s.jsxs("div",{className:"mb-4 p-4",children:[s.jsx("button",{type:"button",onClick:re,disabled:A.isPending,className:"w-full rounded bg-green-600 px-4 py-2 font-semibold text-white hover:bg-green-700 disabled:opacity-50",children:A.isPending?"Saving...":"Save Completed Task"}),s.jsx("p",{className:"mt-2 text-xs text-green-700",children:"Click to save task completion and create next recurring instance (if applicable)"})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Task Name *"}),s.jsx("input",{className:"w-full rounded border border-gray-300 p-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500",value:l,onChange:o=>i(o.target.value),placeholder:"Enter task name",required:!0,disabled:g&&!x})]}),s.jsxs("div",{children:[s.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Details"}),s.jsx("textarea",{className:"w-full rounded border border-gray-300 p-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500",rows:3,value:u,onChange:o=>_(o.target.value),placeholder:"Optional task description",disabled:g&&!x})]}),s.jsxs("div",{children:[s.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Importance (1-10)"}),s.jsx("select",{className:"w-full rounded border border-gray-300 p-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500",value:y,onChange:o=>h(Number(o.target.value)),disabled:g&&!x,children:Array.from({length:10},(o,v)=>v+1).map(o=>s.jsxs("option",{value:o,children:["Level ",o]},o))})]}),s.jsxs("div",{children:[s.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Deadline"}),s.jsx("input",{type:"date",className:"w-full rounded border border-gray-300 p-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500",value:se(f),onChange:o=>N(o.target.value),min:new Date().toISOString().split("T")[0],disabled:g&&!x})]}),s.jsxs("div",{children:[s.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Estimated Completion Time (hours)"}),s.jsx("input",{type:"number",min:"0.5",step:"0.5",className:"w-full rounded border border-gray-300 p-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500",value:E,onChange:o=>m(Number(o.target.value)),placeholder:"e.g. 2.5",disabled:g&&!x})]}),s.jsxs("div",{children:[s.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Unique Days Required"}),s.jsx("input",{type:"number",min:"0.5",step:"0.5",className:"w-full rounded border border-gray-300 p-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500",value:O,onChange:o=>Q(Number(o.target.value)),placeholder:"e.g. 3",disabled:g&&!x}),s.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Number of separate days needed to complete this task"})]}),s.jsx(pe,{initialConfig:{type:b.recurrence_type,interval:b.recurrence_interval||1,dayOfWeek:b.recurrence_day_of_week,dayOfMonth:b.recurrence_day_of_month,endDate:b.recurrence_end_date},onChange:B,disabled:g&&!x,className:"border-t pt-4"}),S&&e&&s.jsx("div",{className:"border-t pt-4",children:s.jsxs("button",{type:"button",onClick:()=>{const o=Se(e);window.open(o,"_blank","noopener,noreferrer")},className:"w-full flex items-center justify-center gap-2 rounded bg-indigo-600 px-4 py-3 font-semibold text-white hover:bg-indigo-700 transition-colors",children:[s.jsx("svg",{className:"h-5 w-5",fill:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:s.jsx("path",{d:"M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-7 5h5v5h-5v-5z"})}),"Add to Google Calendar"]})}),s.jsxs("div",{className:"flex justify-between border-t pt-4",children:[S&&!(g&&!x)&&s.jsx("button",{type:"button",onClick:ne,disabled:I.isPending,className:"rounded bg-red-600 px-4 py-2 text-white hover:bg-red-700 disabled:opacity-50",children:I.isPending?"Deleting...":"Delete Task"}),s.jsxs("div",{className:`${S&&!(g&&!x)?"ml-auto":""} space-x-2`,children:[s.jsx("button",{type:"button",onClick:r,className:"rounded bg-gray-300 px-4 py-2 text-white hover:bg-gray-400",children:"Cancel"}),!(g&&!x)&&s.jsx("button",{type:"submit",disabled:U.isPending||!l.trim(),className:"rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 disabled:opacity-50",children:U.isPending?C?"Creating...":"Saving...":C?"Create Task":"Save Changes"})]})]})]})})}export{p as Q,Ue as T,Re as a,ke as b,qe as c,Oe as d,Me as e,J as f,Te as g,$e as s,R as u};

import{a as u,p as n}from"./chunk-PVWAREVJ-C9qE2fA-.js";import{S as ye,s as fe,h as ee,g as pe,n as te,u as E,b as be,c as _e}from"./QueryClientProvider-CC2Z6-5f.js";import{s as p}from"./supabaseClient-Btf0BZYh.js";import{u as xe}from"./useQuery-jVOp7vHI.js";import{u as ve}from"./AuthContext-CtIaUxkA.js";var we=class extends ye{#t;#n=void 0;#e;#r;constructor(e,r){super(),this.#t=e,this.setOptions(r),this.bindMethods(),this.#s()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){const r=this.options;this.options=this.#t.defaultMutationOptions(e),fe(this.options,r)||this.#t.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#e,observer:this}),r?.mutationKey&&this.options.mutationKey&&ee(r.mutationKey)!==ee(this.options.mutationKey)?this.reset():this.#e?.state.status==="pending"&&this.#e.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#e?.removeObserver(this)}onMutationUpdate(e){this.#s(),this.#a(e)}getCurrentResult(){return this.#n}reset(){this.#e?.removeObserver(this),this.#e=void 0,this.#s(),this.#a()}mutate(e,r){return this.#r=r,this.#e?.removeObserver(this),this.#e=this.#t.getMutationCache().build(this.#t,this.options),this.#e.addObserver(this),this.#e.execute(e)}#s(){const e=this.#e?.state??pe();this.#n={...e,isPending:e.status==="pending",isSuccess:e.status==="success",isError:e.status==="error",isIdle:e.status==="idle",mutate:this.mutate,reset:this.reset}}#a(e){te.batch(()=>{if(this.#r&&this.hasListeners()){const r=this.#n.variables,s=this.#n.context;e?.type==="success"?(this.#r.onSuccess?.(e.data,r,s),this.#r.onSettled?.(e.data,null,r,s)):e?.type==="error"&&(this.#r.onError?.(e.error,r,s),this.#r.onSettled?.(void 0,e.error,r,s))}this.listeners.forEach(r=>{r(this.#n)})})}};function O(e,r){const s=E(),[t]=u.useState(()=>new we(s,e));u.useEffect(()=>{t.setOptions(e)},[t,e]);const a=u.useSyncExternalStore(u.useCallback(l=>t.subscribe(te.batchCalls(l)),[t]),()=>t.getCurrentResult(),()=>t.getCurrentResult()),c=u.useCallback((l,i)=>{t.mutate(l,i).catch(be)},[t]);if(a.error&&_e(t.options.throwOnError,[a.error]))throw a.error;return{...a,mutate:c,mutateAsync:a.mutate}}const y={orgTree:e=>["orgTree",e],allOrgTrees:()=>["orgTree"],task:e=>["task",e],allTasks:()=>["allTasks"],recentTasks:()=>["recentTasks"],urgentTaskCount:e=>e?["urgentTaskCount",e]:["urgentTaskCount"],criticalTaskCount:e=>["criticalTaskCount",e],category:e=>["category",e],allCategories:()=>["categories"],journalEntry:e=>["journalEntry",e]};async function je(){const{data:{user:e},error:r}=await p.auth.getUser();if(r||!e)throw new Error("User must be authenticated to use quick add");const{data:s,error:t}=await p.from("categories").select("id").eq("user_id",e.id).eq("name","Orphans").single();if(t||!s)throw new Error("Orphans category not found. Please contact support.");const a=s.id,{data:c,error:l}=await p.from("org_nodes").select("id, name, type").eq("user_id",e.id).eq("category_id",a).eq("name","Quick Inbox").eq("type","category").maybeSingle();if(l)throw new Error(`Failed to search for Quick Inbox: ${l.message}`);if(c)return c.id;const{data:i,error:d}=await p.from("org_nodes").insert({name:"Quick Inbox",type:"category",category_id:a,user_id:e.id,parent_id:null,details:"Temporary inbox for quick task capture. Organize these tasks later.",importance:null,is_completed:!1}).select().single();if(d||!i)throw new Error(`Failed to create Quick Inbox: ${d?.message||"Unknown error"}`);return i.id}const Ce=()=>{const e=E();return O({mutationFn:async r=>{const{data:{user:s}}=await p.auth.getUser();if(!s)throw new Error("User not authenticated");if(r.id){const{data:t,error:a}=await p.from("org_nodes").update(r).eq("id",r.id).eq("user_id",s.id).select().single();if(a)throw a;return t}else{const{data:t,error:a}=await p.from("org_nodes").insert({...r,type:"task",user_id:s.id}).select().single();if(a)throw a;return t}},onSuccess:r=>{e.setQueryData(y.task(r.id),r),e.invalidateQueries({queryKey:y.allOrgTrees()}),e.invalidateQueries({queryKey:y.allTasks()}),e.invalidateQueries({queryKey:y.urgentTaskCount()})},onError:r=>{console.error("‚ùå Save task error:",r)}})},Ne=()=>{const e=E();return O({mutationFn:async r=>{const{data:{user:s}}=await p.auth.getUser();if(!s)throw new Error("User not authenticated");const{error:t}=await p.from("org_nodes").delete().eq("id",r).eq("user_id",s.id);if(t)throw t;return r},onSuccess:r=>{e.removeQueries({queryKey:y.task(r)}),e.invalidateQueries({queryKey:y.allOrgTrees()}),e.invalidateQueries({queryKey:y.allTasks()}),e.invalidateQueries({queryKey:y.urgentTaskCount()})},onError:r=>{console.error("‚ùå Delete task error:",r)}})},ze=()=>{const e=E();return O({mutationFn:async r=>{if(!r||r.trim()==="")throw new Error("Task name is required");const{data:{user:s}}=await p.auth.getUser();if(!s)throw new Error("User not authenticated");const t=await je(),{data:a,error:c}=await p.from("categories").select("id").eq("user_id",s.id).eq("name","Orphans").single();if(c||!a)throw new Error("Orphans category not found");const{data:l,error:i}=await p.from("org_nodes").insert({name:r.trim(),type:"task",user_id:s.id,parent_id:t,category_id:a.id,importance:1,completion_time:1,unique_days_required:1,details:"",deadline:null,is_completed:!1,recurrence_type:"none",is_recurring_template:!1}).select().single();if(i)throw i;return l},onSuccess:r=>{e.setQueryData(y.task(r.id),r),e.invalidateQueries({queryKey:y.allOrgTrees()}),e.invalidateQueries({queryKey:y.allTasks()}),e.invalidateQueries({queryKey:y.urgentTaskCount()}),e.invalidateQueries({queryKey:y.allCategories()})},onError:r=>{console.error("‚ùå Quick add task error:",r)}})};function ke(e,r){const s=new Date(e),t=new Date(s);switch(r.type){case"minutely":return t.setMinutes(t.getMinutes()+r.interval),t.toISOString();case"daily":t.setDate(t.getDate()+r.interval);break;case"weekly":if(r.dayOfWeek!==void 0){const a=(r.dayOfWeek-t.getDay()+7)%7;t.setDate(t.getDate()+a+(r.interval-1)*7)}else t.setDate(t.getDate()+r.interval*7);break;case"monthly":if(r.dayOfMonth!==void 0)t.setMonth(t.getMonth()+r.interval),t.setDate(Math.min(r.dayOfMonth,re(t)));else{const a=s.getDate();t.setMonth(t.getMonth()+r.interval),t.setDate(Math.min(a,re(t)))}break;case"yearly":t.setFullYear(t.getFullYear()+r.interval);break;default:throw new Error(`Unsupported recurrence type: ${r.type}`)}return r.type==="minutely"?t.toISOString():t.toISOString().split("T")[0]}function Se(e,r){if(!r)return!0;const s=new Date(e),t=new Date(r);return s<=t}function re(e){return new Date(e.getFullYear(),e.getMonth()+1,0).getDate()}function Ee(e){const{type:r,interval:s,dayOfWeek:t,dayOfMonth:a}=e,c=s===1?"Weekly":`Every ${s} weeks`,l=s===1?"Monthly":`Every ${s} months`,i=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];switch(r){case"minutely":return s===1?"Every minute":`Every ${s} minutes`;case"daily":return s===1?"Daily":`Every ${s} days`;case"weekly":return t!==void 0?`${c} on ${i[t]}`:c;case"monthly":if(a!==void 0){const d=De(a);return`${l} on the ${a}${d}`}return l;case"yearly":return s===1?"Yearly":`Every ${s} years`;default:return"No recurrence"}}function De(e){if(e>=11&&e<=13)return"th";switch(e%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}function qe({initialConfig:e,onChange:r,disabled:s=!1,className:t=""}){const[a,c]=u.useState(e?.type||"none"),[l,i]=u.useState(e?.interval||1),[d,x]=u.useState(e?.dayOfWeek??""),[b,h]=u.useState(e?.dayOfMonth??""),[_,k]=u.useState(e?.endDate||""),D=u.useRef("");return u.useEffect(()=>{if(e){const m=JSON.stringify(e);m!==D.current&&(console.log("üîÑ RecurrenceConfig: Updating from initialConfig:",e),c(e.type||"none"),i(e.interval||1),x(e.dayOfWeek??""),h(e.dayOfMonth??""),k(e.endDate||""),D.current=m)}},[e]),u.useEffect(()=>{const m={recurrence_type:a,recurrence_interval:a!=="none"?l:void 0,recurrence_day_of_week:a==="weekly"&&d!==""?Number(d):void 0,recurrence_day_of_month:a==="monthly"&&b!==""?Number(b):void 0,recurrence_end_date:a!=="none"&&_?_:void 0,is_recurring_template:a!=="none"};console.log("üîÑ RecurrenceConfig: Emitting config change:",m),r(m)},[a,l,d,b,_]),n.jsxs("div",{className:`rounded border bg-gray-50 p-4 dark:bg-gray-800 ${t}`,children:[n.jsxs("h4",{className:"mb-3 flex items-center font-medium text-gray-700 dark:text-gray-300",children:[n.jsx("svg",{className:"mr-2 h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})}),"Repeat Task"]}),n.jsxs("div",{className:"mb-3",children:[n.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Repeat:"}),n.jsxs("select",{className:"w-full rounded border border-gray-300 px-3 py-2 text-black focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white",value:a,onChange:m=>{console.log("üîÑ RecurrenceConfig: Type changed to:",m.target.value),c(m.target.value)},disabled:s,children:[n.jsx("option",{value:"none",children:"No repeat"}),n.jsx("option",{value:"minutely",children:"Every minute (testing)"}),n.jsx("option",{value:"daily",children:"Daily"}),n.jsx("option",{value:"weekly",children:"Weekly"}),n.jsx("option",{value:"monthly",children:"Monthly"}),n.jsx("option",{value:"yearly",children:"Yearly"})]})]}),a!=="none"&&n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"mb-3",children:[n.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Every:"}),n.jsxs("div",{className:"flex items-center space-x-2",children:[n.jsx("input",{type:"number",min:"1",max:"365",className:"w-20 rounded border border-gray-300 px-3 py-2 text-black focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white",value:l,onChange:m=>i(Number(m.target.value)),disabled:s}),n.jsxs("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:[a==="minutely"&&(l===1?"minute":"minutes"),a==="daily"&&(l===1?"day":"days"),a==="weekly"&&(l===1?"week":"weeks"),a==="monthly"&&(l===1?"month":"months"),a==="yearly"&&(l===1?"year":"years")]})]})]}),a==="weekly"&&n.jsxs("div",{className:"mb-3",children:[n.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"On day:"}),n.jsxs("select",{className:"w-full rounded border border-gray-300 px-3 py-2 text-black focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white",value:d,onChange:m=>x(m.target.value?Number(m.target.value):""),disabled:s,children:[n.jsx("option",{value:"",children:"Same day as deadline"}),n.jsx("option",{value:"0",children:"Sunday"}),n.jsx("option",{value:"1",children:"Monday"}),n.jsx("option",{value:"2",children:"Tuesday"}),n.jsx("option",{value:"3",children:"Wednesday"}),n.jsx("option",{value:"4",children:"Thursday"}),n.jsx("option",{value:"5",children:"Friday"}),n.jsx("option",{value:"6",children:"Saturday"})]})]}),a==="monthly"&&n.jsxs("div",{className:"mb-3",children:[n.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"On day of month:"}),n.jsxs("select",{className:"w-full rounded border border-gray-300 px-3 py-2 text-black focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white",value:b,onChange:m=>h(m.target.value?Number(m.target.value):""),disabled:s,children:[n.jsx("option",{value:"",children:"Same day as deadline"}),Array.from({length:31},(m,$)=>$+1).map(m=>n.jsx("option",{value:m,children:m},m))]})]}),n.jsxs("div",{className:"mb-3",children:[n.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"End repeat (optional):"}),n.jsx("input",{type:"date",className:"w-full rounded border border-gray-300 px-3 py-2 text-black focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white",value:_,onChange:m=>k(m.target.value),min:new Date().toISOString().split("T")[0],disabled:s})]}),n.jsxs("div",{className:"mt-3 rounded border-l-4 border-blue-400 bg-blue-50 p-2 dark:bg-blue-900/20",children:[n.jsxs("p",{className:"text-sm text-blue-700 dark:text-blue-300",children:[n.jsx("strong",{children:"Pattern:"})," ",Ee({type:a,interval:l,dayOfWeek:d!==""?Number(d):void 0,dayOfMonth:b!==""?Number(b):void 0})]}),_&&n.jsxs("p",{className:"mt-1 text-sm text-blue-700 dark:text-blue-300",children:[n.jsx("strong",{children:"Ends:"})," ",new Date(_).toLocaleDateString()]})]})]})]})}async function Oe(e){if(console.log("üîç DEBUG - createRecurringInstance called with task:",{name:e.name,id:e.id,is_completed:e.is_completed,is_recurring_template:e.is_recurring_template,recurring_template_id:e.recurring_template_id,recurrence_type:e.recurrence_type,deadline:e.deadline,parent_id:e.parent_id}),console.log("üîÑ createRecurringInstance called for task:",e.name),!e.is_recurring_template&&!e.recurring_template_id)return console.log("‚ùå Check 1 FAILED: Task is not recurring",{is_recurring_template:e.is_recurring_template,recurring_template_id:e.recurring_template_id}),null;if(console.log("‚úÖ Check 1 PASSED: Task is recurring"),e.recurrence_type==="none"||!e.recurrence_type)return console.log("‚ùå Check 2 FAILED: No recurrence type set",{recurrence_type:e.recurrence_type}),null;if(console.log("‚úÖ Check 2 PASSED: Recurrence type is set:",e.recurrence_type),!e.is_completed)return console.log("‚ùå Check 3 FAILED: Task is not marked as completed",{is_completed:e.is_completed}),null;console.log("‚úÖ Check 3 PASSED: Task is completed"),console.log("üîç Check 4: Checking for recent instances...");const r=new Date(Date.now()-6e4).toISOString();let s=p.from("org_nodes").select("id, name, created_at").eq("name",e.name).eq("user_id",e.user_id).eq("recurring_template_id",e.is_recurring_template?e.id:e.recurring_template_id).gte("created_at",r);e.parent_id!=null?s=s.eq("parent_id",e.parent_id):s=s.is("parent_id",null);const{data:t,error:a}=await s;if(a)throw console.error("‚ùå Check 4 ERROR: Error checking for recent instances:",a),a;if(console.log("üîç Check 4 RESULT: Recent instances found:",t),t&&t.length>0)return console.log("‚ùå Check 4 FAILED: Recent instance already exists, skipping creation"),null;console.log("‚úÖ Check 4 PASSED: No recent instances found"),console.log("üîç Check 5: Calculating next deadline...");try{const c=ke(e.deadline||new Date().toISOString().split("T")[0],{type:e.recurrence_type,interval:e.recurrence_interval||1,dayOfWeek:e.recurrence_day_of_week,dayOfMonth:e.recurrence_day_of_month,endDate:e.recurrence_end_date});if(console.log("‚úÖ Check 5 PASSED: Next deadline calculated:",c),!Se(c,e.recurrence_end_date))return console.log("‚ùå Check 6 FAILED: Recurrence end date reached",{nextDeadline:c,endDate:e.recurrence_end_date}),null;console.log("‚úÖ Check 6 PASSED: Should create next instance"),console.log(e,"THE FUCKING COMPLETED TASK!!!"),console.log(e.parent_id,"THE FUCKING COMPLETED TASK PARENT_ID!!!!!!!!");const l={name:e.name,type:"task",details:e.details,importance:e.importance,deadline:c,completion_time:e.completion_time,unique_days_required:e.unique_days_required,parent_id:e.parent_id||null,category_id:e.category_id,recurrence_type:e.recurrence_type,recurrence_interval:e.recurrence_interval,recurrence_day_of_week:e.recurrence_day_of_week,recurrence_day_of_month:e.recurrence_day_of_month,recurrence_end_date:e.recurrence_end_date,is_recurring_template:!1,recurring_template_id:e.is_recurring_template?e.id:e.recurring_template_id,user_id:e.user_id};console.log("üîç DEBUG - newTaskData before insertion:",l),console.log("üîÑ Creating next recurring instance:",{originalTask:e.name,newDeadline:c,recurrenceType:e.recurrence_type,newTaskData:l});const{data:i,error:d}=await p.from("org_nodes").insert([l]).select().single();if(d)throw console.error("‚ùå Database error creating recurring instance:",d),d;return console.log("‚úÖ Successfully created recurring instance:",i),i}catch(c){throw console.error("‚ùå Failed to create recurring instance:",c),c}}function $e(){const e=E();return O({mutationFn:async r=>{const{data:{user:s}}=await p.auth.getUser();if(!s)throw new Error("User not authenticated");const{error:t}=await p.from("org_nodes").update({last_touched_at:new Date().toISOString()}).eq("id",r).eq("user_id",s.id);if(t)throw t},onSuccess:()=>{e.invalidateQueries({queryKey:y.recentTasks()})}})}async function Me({id:e,name:r,details:s,importance:t,deadline:a,completion_time:c,unique_days_required:l,is_completed:i,completed_at:d,completion_comment:x}){const{data:{user:b}}=await p.auth.getUser();if(!b)throw new Error("User not authenticated");const h={};r!==void 0&&(h.name=r),s!==void 0&&(h.details=s),t!==void 0&&(h.importance=t),a!==void 0&&(h.deadline=a),c!==void 0&&(h.completion_time=c),l!==void 0&&(h.unique_days_required=l),i!==void 0&&(h.is_completed=i),d!==void 0&&(h.completed_at=d??void 0),x!==void 0&&(h.completion_comment=x),h.last_touched_at=new Date().toISOString();const{data:_,error:k}=await p.from("org_nodes").update(h).eq("id",e).eq("user_id",b.id).select().single();if(k)throw k;return _}const Te={traverse(e,r){r(e),e.children&&e.children.length>0&&e.children.forEach(s=>this.traverse(s,r))},findById(e,r){if(e.id===r)return e;if(e.children&&e.children.length>0)for(const s of e.children){const t=this.findById(s,r);if(t)return t}return null},updateNode(e,r,s){if(e.id===r)return{...e,...s};if(e.children&&e.children.length>0){const t=e.children.map(a=>this.updateNode(a,r,s));return{...e,children:t}}return e},addChild(e,r,s){return r?e.id===r?{...e,children:[...e.children??[],s]}:e.children&&e.children.length>0?{...e,children:e.children.map(t=>this.addChild(t,r,s))}:e:{...e,children:[...e.children??[],s]}},removeNode(e,r){if(e.id===r)return null;if(e.children&&e.children.length>0){const s=e.children.map(t=>this.removeNode(t,r)).filter(t=>t!==null);return{...e,children:s}}return e},getDescendants(e){const r=[e];return e.children&&e.children.length>0&&e.children.forEach(s=>{r.push(...this.getDescendants(s))}),r},getNodePath(e,r){if(e.id===r)return[e];if(e.children&&e.children.length>0)for(const s of e.children){const t=this.getNodePath(s,r);if(t.length>0)return[e,...t]}return[]},countNodes(e){let r=1;return e.children&&e.children.length>0&&(r+=e.children.reduce((s,t)=>s+this.countNodes(t),0)),r},getMaxDepth(e){return!e.children||e.children.length===0?1:1+Math.max(...e.children.map(r=>this.getMaxDepth(r)))},filter(e,r){const s=[];return this.traverse(e,t=>{r(t)&&s.push(t)}),s},map(e,r){const s=r(e);return s.children&&s.children.length>0?{...s,children:s.children.map(t=>this.map(t,r))}:s}};function Ue(e){const r=E();return O({mutationFn:async t=>await Me(t),onMutate:async t=>{await r.cancelQueries({queryKey:y.orgTree(e)});const a=r.getQueryData(y.orgTree(e));if(!a||!t.id)return{previousTree:null};const c={};t.name!==void 0&&(c.name=t.name),t.details!==void 0&&(c.details=t.details),t.importance!==void 0&&(c.importance=t.importance),t.deadline!==void 0&&(c.deadline=t.deadline),t.completion_time!==void 0&&(c.completion_time=t.completion_time),t.unique_days_required!==void 0&&(c.unique_days_required=t.unique_days_required),t.is_completed!==void 0&&(c.is_completed=t.is_completed),t.completed_at!==void 0&&(c.completed_at=t.completed_at===null?void 0:t.completed_at),t.completion_comment!==void 0&&(c.completion_comment=t.completion_comment);const l=Te.updateNode(a,t.id,c);return r.setQueryData(y.orgTree(e),l),{previousTree:a}},onError:(t,a,c)=>{console.log("‚ùå EDIT ONERROR: Edit failed for node:",a.id,"Error:",t),c?.previousTree&&r.setQueryData(y.orgTree(e),c.previousTree)},onSettled:()=>{r.invalidateQueries({queryKey:y.orgTree(e)}),r.invalidateQueries({queryKey:y.urgentTaskCount()}),r.invalidateQueries({queryKey:y.recentTasks()})}})}function ne(e,r,s){if(!e||!r||!s)return 1;const t=new Date,c=new Date(e).getTime()-t.getTime(),l=Math.ceil(c/(1e3*3600*24));if(l<=0||s>=l)return 10;try{const i=s/l*(r/l)+Math.exp(4*(s/l)/(1-s/l))-1;return i<.25?1:i>=.25&&i<.5?2:i>=.5&&i<1?3:i>=1&&i<1.75?4:i>=1.75&&i<2.5?5:i>=2.5&&i<4?6:i>=4&&i<5.5?7:i>=5.5&&i<7.5?8:i>=7.5&&i<10?9:10}catch(i){return console.warn("Urgency calculation failed:",i),1}}function Re(e){return e.type!=="task"?1:ne(e.deadline,e.completion_time,e.unique_days_required)}function He(e=1){switch(e){case 1:return"";case 2:return"bg-lime-400";case 3:return"bg-yellow-400";case 4:return"bg-yellow-500";case 5:return"bg-amber-500";case 6:return"bg-orange-400";case 7:return"bg-orange-500";case 8:return"bg-red-400";case 9:return"bg-red-500";case 10:return"bg-red-600";default:return""}}function Ge(e=1){if(e<=1)return"";switch(e){case 2:case 3:return"w-2 h-2";case 4:case 5:case 6:return"w-3 h-3";case 7:case 8:return"w-4 h-4";case 9:case 10:return"w-5 h-5";default:return"w-2 h-2"}}function Ie(e=1){if(e<=1)return 0;switch(e){case 2:return 4;case 3:return 3.5;case 4:return 3;case 5:return 2.5;case 6:return 2;case 7:return 1.5;case 8:return 1.2;case 9:return 1;case 10:return .8;default:return 2}}function Ve(e=1){if(e<=1)return"";switch(e){case 2:return"shadow-sm shadow-lime-400/50";case 3:return"shadow-sm shadow-yellow-400/50";case 4:return"shadow-sm shadow-yellow-500/50";case 5:return"shadow-md shadow-amber-500/50";case 6:return"shadow-md shadow-orange-400/50";case 7:return"shadow-md shadow-orange-500/50";case 8:return"shadow-lg shadow-red-400/60";case 9:return"shadow-lg shadow-red-500/70";case 10:return"shadow-xl shadow-red-600/80";default:return""}}function Ye(e=1){return e>1}function Je(e){const r=e.getBoundingClientRect(),s=r.width,t=r.height,a=window.getComputedStyle(e),c=parseFloat(a.borderRadius)||8,l=Math.min(s,t)/2,i=Math.min(c,l),d=[],x=0,b=s,h=0,_=t;return d.push(`M ${s/2} ${h}`),d.push(`L ${b-i} ${h}`),d.push(`Q ${b} ${h} ${b} ${h+i}`),d.push(`L ${b} ${_-i}`),d.push(`Q ${b} ${_} ${b-i} ${_}`),d.push(`L ${x+i} ${_}`),d.push(`Q ${x} ${_} ${x} ${_-i}`),d.push(`L ${x} ${h+i}`),d.push(`Q ${x} ${h} ${x+i} ${h}`),d.push(`L ${s/2} ${h}`),d.join(" ")}function Xe(e=1){return{duration:Ie(e),ease:"none",repeat:-1,autoRotate:e>=7,yoyo:!1}}function se(e){if(e.type==="task")return Re(e);if(!e.children||e.children.length===0)return 1;const r=e.children.map(s=>se(s));return Math.max(...r)}function Ze(e){return se(e)}function Pe(e){const r="https://calendar.google.com/calendar/render",s=new URLSearchParams({action:"TEMPLATE"});s.append("text",e.name);const t=[];if(e.importance&&t.push(`‚≠ê Importance: ${e.importance}/10`),e.deadline&&e.completion_time!==void 0&&e.unique_days_required!==void 0){const a=ne(e.deadline,e.completion_time,e.unique_days_required);t.push(`üî• Urgency: ${a}/10`)}return e.details&&t.push("","üìã DETAILS:",e.details),e.completion_time&&t.push("",`‚è±Ô∏è Estimated time: ${e.completion_time} minutes`),s.append("details",t.join(`
`)),`${r}?${s.toString()}`}async function Qe(e,r=!1){let s=p.from("categories").select("*").eq("user_id",e);r||(s=s.eq("archived",!1));const{data:t,error:a}=await s.order("order_index",{ascending:!0});if(a)throw console.error("Error fetching categories:",a),new Error(a.message);return t||[]}function Le(){const{user:e}=ve();return xe({queryKey:y.allCategories(),queryFn:()=>{if(!e?.id)throw new Error("User not authenticated");return Qe(e.id)},enabled:!!e?.id,staleTime:1e3*60*5})}function er({task:e,onCancel:r,parentId:s,parentName:t,categoryId:a,categoryName:c}){const[l,i]=u.useState(e?.name??""),[d,x]=u.useState(e?.details??""),[b,h]=u.useState(e?.importance??1),[_,k]=u.useState(e?.deadline??""),[D,m]=u.useState(e?.completion_time??1),[$,B]=u.useState(e?.unique_days_required??1),[g,z]=u.useState(e?.is_completed??!1),[M,H]=u.useState(e?.completion_comment??""),[S,I]=u.useState(e?.completed_at??null),[v,G]=u.useState({recurrence_type:"none",recurrence_interval:void 0,recurrence_day_of_week:void 0,recurrence_day_of_month:void 0,recurrence_end_date:void 0,is_recurring_template:!1}),[j,ae]=u.useState(e?.category_id||a),[T,V]=u.useState(e?.parent_id||s),[P,Y]=u.useState([]),[oe,J]=u.useState(!1),Q=Ce(),L=Ne(),ie=$e(),A=Ue(e?.category_id||a),F=Le(),q=!e,C=!!e,U=u.useRef(!1),K=u.useRef(!1),[w,W]=u.useState(!1);u.useEffect(()=>{if(e){i(e.name),x(e.details??""),h(e.importance??1),k(e.deadline??""),m(e.completion_time??1),B(e.unique_days_required??1),z(e.is_completed??!1),H(e.completion_comment??""),I(e.completed_at??null);const o=e.recurrence_type||"none";G({recurrence_type:o,recurrence_interval:o!=="none"?e.recurrence_interval||1:void 0,recurrence_day_of_week:o==="weekly"?e.recurrence_day_of_week:void 0,recurrence_day_of_month:o==="monthly"?e.recurrence_day_of_month:void 0,recurrence_end_date:o!=="none"?e.recurrence_end_date:void 0,is_recurring_template:o!=="none"}),U.current=!1,W(!1)}},[e]),u.useEffect(()=>{e?.id&&ie.mutate(String(e.id))},[e?.id]),u.useEffect(()=>{(async()=>{if(j){J(!0);try{const{data:f,error:N}=await p.from("org_nodes").select("*").eq("category_id",j).eq("type","category").order("name");if(N)throw N;Y(f||[])}catch(f){console.error("Failed to fetch parent categories:",f),Y([])}finally{J(!1)}}})()},[j]);const ce=()=>{const o=F.data?.find(f=>f.name==="Orphans");return o&&j===o.id},le=o=>F.data?.find(f=>f.id===o)?.name||"Unknown",de=o=>{z(o),W(!0),o&&!e?.is_completed?I(new Date().toISOString()):!o&&e?.is_completed&&I(null)},ue=async()=>{if(!e)return;if(K.current){console.log("üîÑ Already processing completion, skipping...");return}K.current=!0;const o={id:e.id,is_completed:g,completion_comment:M||void 0,completed_at:S||void 0};console.log("üöÄ Saving task completion:",o),A.mutate(o,{onSuccess:async()=>{if(console.log("‚úÖ Task completion saved successfully"),W(!1),g&&!e.is_completed&&!U.current&&v.recurrence_type!=="none"&&v.recurrence_type){console.log("üîÑ Task completed with recurrence, creating next instance..."),U.current=!0;try{const f={...e,is_completed:!0,completed_at:S||void 0,completion_comment:M,recurrence_type:v.recurrence_type,recurrence_interval:v.recurrence_interval,recurrence_day_of_week:v.recurrence_day_of_week,recurrence_day_of_month:v.recurrence_day_of_month,recurrence_end_date:v.recurrence_end_date,is_recurring_template:v.is_recurring_template},N=await Oe(f);N&&console.log("‚úÖ Successfully created recurring instance:",N.name)}catch(f){console.error("‚ùå Failed to create recurring instance:",f),U.current=!1}}g&&r()},onError:f=>{console.error("‚ùå Failed to save task completion:",f),alert(`Failed to save completion: ${f.message}`)},onSettled:()=>{K.current=!1}})},he=o=>{o.preventDefault();const f=T??s,N=j??a;if(!f||!N){console.error("‚ùå Missing required parent context for task:",{parentId:f,categoryId:N}),alert("Please select a category and parent location for this task.");return}const Z={id:e?.id,name:l.trim(),details:d.trim()||void 0,importance:b,deadline:_||void 0,completion_time:D,unique_days_required:$,parent_id:f,category_id:N,type:"task",...C&&!w&&{is_completed:g,completion_comment:M||void 0,completed_at:S||void 0},...v};console.log("üöÄ Submitting task data:",Z),Q.mutate(Z,{onSuccess:R=>{console.log("‚úÖ Task saved successfully:",R),r()},onError:R=>{console.error("‚ùå Failed to save task:",R),alert(`Failed to save task: ${R.message}`)}})},me=()=>{if(e?.id){if(!confirm(`Are you sure you want to delete "${e.name}"?`))return;console.log("üóëÔ∏è Deleting task:",e.id),L.mutate(e.id,{onSuccess:()=>{console.log("‚úÖ Task deleted successfully"),r()},onError:o=>{console.error("‚ùå Failed to delete task:",o),alert(`Failed to delete task: ${o.message}`)}})}},ge=o=>o?new Date(o).toISOString().split("T")[0]:"",X=()=>C&&c?c:q&&t&&c?`${c} > ${t}`:"Unknown";return n.jsx("div",{className:"bg-opacity-50 fixed inset-0 z-[70] flex items-center justify-center bg-black",children:n.jsxs("form",{onSubmit:he,className:"mx-4 max-h-[90vh] w-full max-w-md space-y-4 overflow-y-auto rounded-lg bg-white p-6 text-black shadow-md",children:[n.jsxs("div",{className:"mb-4 flex items-center justify-between",children:[n.jsxs("div",{children:[n.jsx("h3",{className:"text-xl font-bold",children:q?"Create New Task":"Edit Task"}),n.jsx("p",{className:"text-sm text-gray-600",children:q?`Adding to: ${X()}`:`Category: ${X()}`})]}),n.jsx("button",{type:"button",onClick:r,className:"text-2xl font-bold text-gray-500 hover:text-gray-800",children:"√ó"})]}),C&&ce()&&n.jsxs("div",{className:"mb-4 rounded-lg border-2 border-amber-400 bg-amber-50 p-4",children:[n.jsxs("div",{className:"mb-3 flex items-center gap-2",children:[n.jsx("svg",{className:"h-6 w-6 text-amber-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})}),n.jsx("h4",{className:"font-semibold text-amber-900",children:"Quick Task - Needs Organization"})]}),n.jsx("p",{className:"mb-3 text-sm text-amber-800",children:"This task was created with Quick Add and needs to be moved to a proper category."})]}),C&&n.jsxs("div",{className:"mb-4 space-y-3 rounded-lg border border-gray-200 bg-gray-50 p-4",children:[n.jsx("h4",{className:"font-semibold text-gray-700",children:"Task Location"}),n.jsxs("div",{children:[n.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Category *"}),n.jsxs("select",{className:"w-full rounded border border-gray-300 p-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500",value:j,onChange:o=>{ae(o.target.value),V(void 0)},disabled:g&&!w,children:[n.jsx("option",{value:"",children:"Select a category..."}),F.data?.map(o=>n.jsx("option",{value:o.id,children:o.name},o.id))]})]}),j&&n.jsxs("div",{children:[n.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Parent Category *"}),oe?n.jsxs("div",{className:"flex items-center gap-2 p-2 text-sm text-gray-500",children:[n.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-gray-300 border-t-blue-600"}),"Loading categories..."]}):P.length===0?n.jsx("p",{className:"p-2 text-sm text-amber-600",children:"No parent categories available in this category. Please select a different category."}):n.jsxs("select",{className:"w-full rounded border border-gray-300 p-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500",value:T||"",onChange:o=>V(o.target.value?Number(o.target.value):void 0),disabled:g&&!w,children:[n.jsx("option",{value:"",children:"Select a parent..."}),P.map(o=>n.jsx("option",{value:o.id,children:o.name},o.id))]})]}),j&&T&&n.jsxs("p",{className:"text-xs text-gray-500",children:["Task will be moved to: ",le(j)," "," > ",P.find(o=>o.id===T)?.name]})]}),C&&n.jsxs("div",{className:`mb-6 rounded-lg border p-4 ${g?"border-green-300 bg-green-50":"border-gray-200 bg-gray-50"}`,children:[n.jsxs("div",{className:"mb-3 flex items-center justify-between",children:[n.jsxs("label",{className:"flex cursor-pointer items-center font-semibold text-gray-700",children:[n.jsx("input",{type:"checkbox",checked:g,onChange:o=>de(o.target.checked),className:"mr-2 h-5 w-5 cursor-pointer rounded text-green-600 focus:ring-green-500"}),n.jsx("span",{className:g?"text-green-700":"",children:g?"Task Completed":"Mark as Completed"})]}),S&&n.jsx("span",{className:"text-sm text-gray-500",children:new Date(S).toLocaleDateString()})]}),g&&n.jsxs("div",{className:"mt-3",children:[n.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Completion Notes (optional):"}),n.jsx("textarea",{className:"w-full rounded border p-2 text-sm text-black focus:border-green-500 focus:ring-2 focus:ring-green-500",rows:3,placeholder:"Add any notes about completing this task...",value:M,onChange:o=>H(o.target.value)}),S&&n.jsxs("p",{className:"mt-1 text-xs text-gray-500",children:["Completed on ",new Date(S).toLocaleString()]})]}),C&&w&&g&&n.jsxs("div",{className:"mb-4 p-4",children:[n.jsx("button",{type:"button",onClick:ue,disabled:A.isPending,className:"w-full rounded bg-green-600 px-4 py-2 font-semibold text-white hover:bg-green-700 disabled:opacity-50",children:A.isPending?"Saving...":"Save Completed Task"}),n.jsx("p",{className:"mt-2 text-xs text-green-700",children:"Click to save task completion and create next recurring instance (if applicable)"})]})]}),n.jsxs("div",{children:[n.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Task Name *"}),n.jsx("input",{className:"w-full rounded border border-gray-300 p-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500",value:l,onChange:o=>i(o.target.value),placeholder:"Enter task name",required:!0,disabled:g&&!w})]}),n.jsxs("div",{children:[n.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Details"}),n.jsx("textarea",{className:"w-full rounded border border-gray-300 p-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500",rows:3,value:d,onChange:o=>x(o.target.value),placeholder:"Optional task description",disabled:g&&!w})]}),n.jsxs("div",{children:[n.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Importance (1-10)"}),n.jsx("select",{className:"w-full rounded border border-gray-300 p-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500",value:b,onChange:o=>h(Number(o.target.value)),disabled:g&&!w,children:Array.from({length:10},(o,f)=>f+1).map(o=>n.jsxs("option",{value:o,children:["Level ",o]},o))})]}),n.jsxs("div",{children:[n.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Deadline"}),n.jsx("input",{type:"date",className:"w-full rounded border border-gray-300 p-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500",value:ge(_),onChange:o=>k(o.target.value),min:new Date().toISOString().split("T")[0],disabled:g&&!w})]}),n.jsxs("div",{children:[n.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Estimated Completion Time (hours)"}),n.jsx("input",{type:"number",min:"0.5",step:"0.5",className:"w-full rounded border border-gray-300 p-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500",value:D,onChange:o=>m(Number(o.target.value)),placeholder:"e.g. 2.5",disabled:g&&!w})]}),n.jsxs("div",{children:[n.jsx("label",{className:"mb-1 block text-sm font-medium text-gray-700",children:"Unique Days Required"}),n.jsx("input",{type:"number",min:"0.5",step:"0.5",className:"w-full rounded border border-gray-300 p-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500",value:$,onChange:o=>B(Number(o.target.value)),placeholder:"e.g. 3",disabled:g&&!w}),n.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Number of separate days needed to complete this task"})]}),n.jsx(qe,{initialConfig:{type:v.recurrence_type,interval:v.recurrence_interval||1,dayOfWeek:v.recurrence_day_of_week,dayOfMonth:v.recurrence_day_of_month,endDate:v.recurrence_end_date},onChange:G,disabled:g&&!w,className:"border-t pt-4"}),C&&e&&n.jsx("div",{className:"border-t pt-4",children:n.jsxs("button",{type:"button",onClick:()=>{const o=Pe(e);window.open(o,"_blank","noopener,noreferrer")},className:"w-full flex items-center justify-center gap-2 rounded bg-indigo-600 px-4 py-3 font-semibold text-white hover:bg-indigo-700 transition-colors",children:[n.jsx("svg",{className:"h-5 w-5",fill:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:n.jsx("path",{d:"M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-7 5h5v5h-5v-5z"})}),"Add to Google Calendar"]})}),n.jsxs("div",{className:"flex justify-between border-t pt-4",children:[C&&!(g&&!w)&&n.jsx("button",{type:"button",onClick:me,disabled:L.isPending,className:"rounded bg-red-600 px-4 py-2 text-white hover:bg-red-700 disabled:opacity-50",children:L.isPending?"Deleting...":"Delete Task"}),n.jsxs("div",{className:`${C&&!(g&&!w)?"ml-auto":""} space-x-2`,children:[n.jsx("button",{type:"button",onClick:r,className:"rounded bg-gray-300 px-4 py-2 text-white hover:bg-gray-400",children:"Cancel"}),!(g&&!w)&&n.jsx("button",{type:"submit",disabled:Q.isPending||!l.trim(),className:"rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 disabled:opacity-50",children:Q.isPending?q?"Creating...":"Saving...":q?"Create Task":"Save Changes"})]})]})]})})}export{y as Q,er as T,Le as a,Xe as b,Je as c,He as d,Ge as e,Ve as f,Ze as g,ze as h,ne as i,Ye as s,O as u};
